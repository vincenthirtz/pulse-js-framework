/**
 * Pulse Weather App - Main Application
 */

import SearchBar from './components/SearchBar.pulse'
import FavoritesList from './components/FavoritesList.pulse'
import CurrentWeather from './components/CurrentWeather.pulse'
import Forecast from './components/Forecast.pulse'

@page App

state {
  city: "Paris"
  weather: null
  forecast: []
  loading: false
  error: null
  unit: "celsius"
  favorites: []
}

view {
  .weather-app {
    h1.app-title "ðŸŒ¤ï¸ Pulse Weather"
    SearchBar(onSearch={fetchWeather})
    .content {
      .sidebar {
        FavoritesList(
          favorites={favorites},
          onSelect={fetchWeather},
          onRemove={removeFromFavorites}
        )
      }
      .main {
        CurrentWeather(
          weather={weather},
          loading={loading},
          error={error},
          unit={unit},
          isFavorite={isFavorite()},
          onToggleUnit={toggleUnit},
          onToggleFavorite={toggleFavorite}
        )
        @if (forecast.length > 0) {
          Forecast(forecast={forecast}, unit={unit})
        }
      }
    }
    footer.app-footer "Built with âœ¨ Pulse Framework â€¢ Data by Open-Meteo"
  }
}

actions {
  init() {
    const savedFavorites = localStorage.getItem("weather-favorites")
    if (savedFavorites) {
      favorites = JSON.parse(savedFavorites)
    } else {
      favorites = ["Paris", "London", "New York", "Tokyo"]
    }
    fetchWeather("Paris")
  }

  async getCoordinates(cityName) {
    const response = await fetch(
      "https://geocoding-api.open-meteo.com/v1/search?name=" + encodeURIComponent(cityName) + "&count=1&language=en&format=json"
    )
    const data = await response.json()

    if (!data.results || data.results.length === 0) {
      throw new Error("City \"" + cityName + "\" not found")
    }

    return {
      lat: data.results[0].latitude,
      lon: data.results[0].longitude,
      name: data.results[0].name,
      country: data.results[0].country
    }
  }

  async getWeatherData(lat, lon) {
    const response = await fetch(
      "https://api.open-meteo.com/v1/forecast?latitude=" + lat + "&longitude=" + lon + "&current=temperature_2m,relative_humidity_2m,apparent_temperature,weather_code,wind_speed_10m,wind_direction_10m&daily=weather_code,temperature_2m_max,temperature_2m_min,precipitation_probability_max&timezone=auto"
    )
    return response.json()
  }

  async fetchWeather(cityName) {
    loading = true
    error = null

    try {
      const coords = await getCoordinates(cityName)
      const data = await getWeatherData(coords.lat, coords.lon)

      weather = {
        city: coords.name,
        country: coords.country,
        temp: Math.round(data.current.temperature_2m),
        feelsLike: Math.round(data.current.apparent_temperature),
        humidity: data.current.relative_humidity_2m,
        windSpeed: Math.round(data.current.wind_speed_10m),
        windDir: data.current.wind_direction_10m,
        code: data.current.weather_code
      }

      const days = []
      for (let i = 0; i < 7; i++) {
        days.push({
          date: data.daily.time[i],
          code: data.daily.weather_code[i],
          tempMax: Math.round(data.daily.temperature_2m_max[i]),
          tempMin: Math.round(data.daily.temperature_2m_min[i]),
          precipitation: data.daily.precipitation_probability_max[i]
        })
      }
      forecast = days
      city = coords.name

    } catch (err) {
      error = err.message
      weather = null
      forecast = []
    } finally {
      loading = false
    }
  }

  toggleUnit() {
    unit = unit === "celsius" ? "fahrenheit" : "celsius"
  }

  isFavorite() {
    return favorites.includes(city)
  }

  toggleFavorite() {
    if (isFavorite()) {
      removeFromFavorites(city)
    } else {
      addToFavorites()
    }
  }

  addToFavorites() {
    if (!favorites.includes(city)) {
      favorites = [...favorites, city]
      localStorage.setItem("weather-favorites", JSON.stringify(favorites))
    }
  }

  removeFromFavorites(cityName) {
    favorites = favorites.filter(f => f !== cityName)
    localStorage.setItem("weather-favorites", JSON.stringify(favorites))
  }
}

style {
  :root {
    --bg: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    --card-bg: rgba(255, 255, 255, 0.95);
    --card-bg-hover: rgba(255, 255, 255, 1);
    --text: #333;
    --text-light: #666;
    --primary: #667eea;
    --shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
    --radius: 16px;
  }

  * {
    box-sizing: border-box;
    margin: 0;
    padding: 0;
  }

  body {
    font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
    background: var(--bg);
    min-height: 100vh;
    color: var(--text);
  }

  .weather-app {
    max-width: 1000px;
    margin: 0 auto;
    padding: 24px;
    min-height: 100vh;
  }

  .app-title {
    text-align: center;
    color: white;
    font-size: 2.5em;
    margin-bottom: 24px;
    text-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
  }

  .content {
    display: grid;
    grid-template-columns: 200px 1fr;
    gap: 24px;
  }

  @media (max-width: 768px) {
    .content {
      grid-template-columns: 1fr;
    }

    .sidebar {
      order: 2;
    }
  }

  .sidebar {
    display: flex;
    flex-direction: column;
    gap: 16px;
  }

  .main {
    display: flex;
    flex-direction: column;
    gap: 24px;
  }

  .app-footer {
    text-align: center;
    padding: 24px;
    color: rgba(255, 255, 255, 0.8);
    font-size: 0.9em;
  }
}
