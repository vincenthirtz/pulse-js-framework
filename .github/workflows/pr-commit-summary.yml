name: PR Commit Summary

on:
  pull_request:
    types: [opened, synchronize]

permissions:
  pull-requests: write
  contents: read

jobs:
  update-summary:
    name: Update PR Summary
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Fetch all history for accurate commit analysis

      - name: Get PR information
        id: pr-info
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          PR_NUMBER="${{ github.event.pull_request.number }}"
          BASE_SHA="${{ github.event.pull_request.base.sha }}"
          HEAD_SHA="${{ github.event.pull_request.head.sha }}"

          echo "pr_number=$PR_NUMBER" >> $GITHUB_OUTPUT
          echo "base_sha=$BASE_SHA" >> $GITHUB_OUTPUT
          echo "head_sha=$HEAD_SHA" >> $GITHUB_OUTPUT

      - name: Generate commit summary
        id: summary
        run: |
          BASE_SHA="${{ steps.pr-info.outputs.base_sha }}"
          HEAD_SHA="${{ steps.pr-info.outputs.head_sha }}"

          # Get commit list
          COMMITS=$(git log --format="%h|%s|%an|%ar" $BASE_SHA..$HEAD_SHA | tac)

          # Count commits
          COMMIT_COUNT=$(echo "$COMMITS" | wc -l | tr -d ' ')

          # Get changed files statistics
          FILES_CHANGED=$(git diff --name-status $BASE_SHA..$HEAD_SHA | wc -l | tr -d ' ')
          ADDITIONS=$(git diff --shortstat $BASE_SHA..$HEAD_SHA | grep -oE '[0-9]+ insertion' | grep -oE '[0-9]+' || echo "0")
          DELETIONS=$(git diff --shortstat $BASE_SHA..$HEAD_SHA | grep -oE '[0-9]+ deletion' | grep -oE '[0-9]+' || echo "0")

          # Generate markdown summary
          cat > /tmp/summary.md << 'EOF'
          ## üìù Commit Summary

          **Total commits:** $COMMIT_COUNT | **Files changed:** $FILES_CHANGED | **+$ADDITIONS** | **-$DELETIONS**

          ### Recent Commits

          EOF

          # Add commit table
          echo "| Commit | Message | Author | Time |" >> /tmp/summary.md
          echo "|--------|---------|--------|------|" >> /tmp/summary.md

          echo "$COMMITS" | while IFS='|' read -r hash message author time; do
            # Escape special characters in message
            message=$(echo "$message" | sed 's/|/\\|/g')
            echo "| \`$hash\` | $message | $author | $time |" >> /tmp/summary.md
          done

          # Add changed files section
          echo "" >> /tmp/summary.md
          echo "### üìÇ Changed Files" >> /tmp/summary.md
          echo "" >> /tmp/summary.md
          echo "<details>" >> /tmp/summary.md
          echo "<summary>View changed files ($FILES_CHANGED files)</summary>" >> /tmp/summary.md
          echo "" >> /tmp/summary.md
          echo "\`\`\`diff" >> /tmp/summary.md
          git diff --name-status $BASE_SHA..$HEAD_SHA | while read status file; do
            case $status in
              A) echo "+ $file" ;;
              D) echo "- $file" ;;
              M) echo "~ $file" ;;
              R*) echo "‚Üí $file" ;;
            esac
          done >> /tmp/summary.md
          echo "\`\`\`" >> /tmp/summary.md
          echo "</details>" >> /tmp/summary.md

          # Add file type breakdown
          echo "" >> /tmp/summary.md
          echo "### üìä Changes by File Type" >> /tmp/summary.md
          echo "" >> /tmp/summary.md

          git diff --name-only $BASE_SHA..$HEAD_SHA | sed 's/.*\.//' | sort | uniq -c | sort -rn | head -10 | while read count ext; do
            echo "- **.$ext**: $count file(s)" >> /tmp/summary.md
          done

          # Replace variables
          sed -i "s/\$COMMIT_COUNT/$COMMIT_COUNT/g" /tmp/summary.md
          sed -i "s/\$FILES_CHANGED/$FILES_CHANGED/g" /tmp/summary.md
          sed -i "s/\$ADDITIONS/$ADDITIONS/g" /tmp/summary.md
          sed -i "s/\$DELETIONS/$DELETIONS/g" /tmp/summary.md

          # Add footer
          cat >> /tmp/summary.md << 'FOOTER'

          ---

          <sub>ü§ñ Auto-generated summary ‚Ä¢ Last updated: $(date -u '+%Y-%m-%d %H:%M:%S UTC')</sub>
          FOOTER

          sed -i "s/\$(date -u '+%Y-%m-%d %H:%M:%S UTC')/$(date -u '+%Y-%m-%d %H:%M:%S UTC')/g" /tmp/summary.md

      - name: Post or update comment
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          PR_NUMBER="${{ steps.pr-info.outputs.pr_number }}"

          # Check if comment already exists
          COMMENT_ID=$(gh api \
            -H "Accept: application/vnd.github+json" \
            "/repos/${{ github.repository }}/issues/$PR_NUMBER/comments" \
            --jq '.[] | select(.user.login == "github-actions[bot]" and (.body | contains("üìù Commit Summary"))) | .id' \
            | head -1)

          SUMMARY_BODY=$(cat /tmp/summary.md)

          if [ -n "$COMMENT_ID" ]; then
            # Update existing comment
            echo "Updating existing comment ID: $COMMENT_ID"
            gh api \
              --method PATCH \
              -H "Accept: application/vnd.github+json" \
              "/repos/${{ github.repository }}/issues/comments/$COMMENT_ID" \
              -f body="$SUMMARY_BODY"
          else
            # Create new comment
            echo "Creating new comment"
            gh pr comment $PR_NUMBER --body "$SUMMARY_BODY"
          fi

      - name: Update PR description (optional)
        if: github.event.action == 'opened'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          PR_NUMBER="${{ steps.pr-info.outputs.pr_number }}"

          # Get current PR description
          CURRENT_DESC=$(gh pr view $PR_NUMBER --json body -q .body)

          # Append summary marker if not present
          if ! echo "$CURRENT_DESC" | grep -q "## üìù Commit Summary"; then
            SUMMARY=$(cat /tmp/summary.md)
            NEW_DESC="${CURRENT_DESC}

---

${SUMMARY}"

            # Update PR description
            gh pr edit $PR_NUMBER --body "$NEW_DESC"
          fi
