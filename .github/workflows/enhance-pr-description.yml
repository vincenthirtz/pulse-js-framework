name: Enhance PR Description

# Ce workflow am√©liore automatiquement la description des PRs
# avec les commits, les fichiers chang√©s, et les statistiques

on:
  pull_request:
    types: [opened, reopened]
    branches:
      - main
      - develop

permissions:
  contents: read
  pull-requests: write

jobs:
  enhance-description:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ github.event.pull_request.head.sha }}

      - name: Get PR details
        id: pr_details
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # R√©cup√©rer les d√©tails de la PR
          PR_NUMBER="${{ github.event.pull_request.number }}"
          BASE_REF="${{ github.event.pull_request.base.ref }}"
          HEAD_REF="${{ github.event.pull_request.head.ref }}"

          echo "PR_NUMBER=$PR_NUMBER" >> $GITHUB_OUTPUT
          echo "BASE_REF=$BASE_REF" >> $GITHUB_OUTPUT
          echo "HEAD_REF=$HEAD_REF" >> $GITHUB_OUTPUT

      - name: Analyze commits
        id: analyze
        run: |
          BASE="${{ github.event.pull_request.base.sha }}"
          HEAD="${{ github.event.pull_request.head.sha }}"

          # Fetch base branch
          git fetch origin ${{ github.event.pull_request.base.ref }}

          # Commits
          COMMITS=$(git log $BASE..$HEAD --pretty=format:"- %s (%h)" --no-merges)
          if [ -z "$COMMITS" ]; then
            COMMIT_COUNT=0
          else
            COMMIT_COUNT=$(echo "$COMMITS" | wc -l | tr -d ' ')
          fi

          # Stats par type de commit (Conventional Commits)
          FEAT_COUNT=$(echo "$COMMITS" | grep -c "^- feat" || echo 0)
          FIX_COUNT=$(echo "$COMMITS" | grep -c "^- fix" || echo 0)
          DOCS_COUNT=$(echo "$COMMITS" | grep -c "^- docs" || echo 0)
          CHORE_COUNT=$(echo "$COMMITS" | grep -c "^- chore" || echo 0)
          REFACTOR_COUNT=$(echo "$COMMITS" | grep -c "^- refactor" || echo 0)
          TEST_COUNT=$(echo "$COMMITS" | grep -c "^- test" || echo 0)
          BREAKING_COUNT=$(echo "$COMMITS" | grep -c "!" || echo 0)

          # Fichiers modifi√©s
          FILES_CHANGED=$(git diff --name-only $BASE...$HEAD | wc -l | tr -d ' \n')

          # Extraire additions et deletions de fa√ßon robuste
          SHORTSTAT=$(git diff --shortstat $BASE...$HEAD)
          ADDITIONS=$(echo "$SHORTSTAT" | grep -oE '[0-9]+ insertion' | grep -oE '[0-9]+' | tr -d '\n' || echo "0")
          DELETIONS=$(echo "$SHORTSTAT" | grep -oE '[0-9]+ deletion' | grep -oE '[0-9]+' | tr -d '\n' || echo "0")

          # S'assurer qu'on a des valeurs valides
          ADDITIONS=${ADDITIONS:-0}
          DELETIONS=${DELETIONS:-0}

          # Fichiers par cat√©gorie
          SRC_FILES=$(git diff --name-only $BASE...$HEAD | grep -c "^src/" || echo 0)
          TEST_FILES=$(git diff --name-only $BASE...$HEAD | grep -c "^test/" || echo 0)
          DOCS_FILES=$(git diff --name-only $BASE...$HEAD | grep -c "^docs/" || echo 0)
          CONFIG_FILES=$(git diff --name-only $BASE...$HEAD | grep -cE '\.(json|yml|yaml|toml|md)$' || echo 0)

          # D√©terminer le type de release sugg√©r√©
          SUGGESTED_RELEASE="patch"
          if [ "$BREAKING_COUNT" -gt 0 ]; then
            SUGGESTED_RELEASE="major"
          elif [ "$FEAT_COUNT" -gt 0 ]; then
            SUGGESTED_RELEASE="minor"
          fi

          # Sauvegarder dans outputs
          echo "COMMITS<<EOF" >> $GITHUB_OUTPUT
          echo "$COMMITS" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

          echo "COMMIT_COUNT=$COMMIT_COUNT" >> $GITHUB_OUTPUT
          echo "FEAT_COUNT=$FEAT_COUNT" >> $GITHUB_OUTPUT
          echo "FIX_COUNT=$FIX_COUNT" >> $GITHUB_OUTPUT
          echo "DOCS_COUNT=$DOCS_COUNT" >> $GITHUB_OUTPUT
          echo "CHORE_COUNT=$CHORE_COUNT" >> $GITHUB_OUTPUT
          echo "REFACTOR_COUNT=$REFACTOR_COUNT" >> $GITHUB_OUTPUT
          echo "TEST_COUNT=$TEST_COUNT" >> $GITHUB_OUTPUT
          echo "BREAKING_COUNT=$BREAKING_COUNT" >> $GITHUB_OUTPUT
          echo "FILES_CHANGED=$FILES_CHANGED" >> $GITHUB_OUTPUT
          echo "ADDITIONS=$ADDITIONS" >> $GITHUB_OUTPUT
          echo "DELETIONS=$DELETIONS" >> $GITHUB_OUTPUT
          echo "SRC_FILES=$SRC_FILES" >> $GITHUB_OUTPUT
          echo "TEST_FILES=$TEST_FILES" >> $GITHUB_OUTPUT
          echo "DOCS_FILES=$DOCS_FILES" >> $GITHUB_OUTPUT
          echo "CONFIG_FILES=$CONFIG_FILES" >> $GITHUB_OUTPUT
          echo "SUGGESTED_RELEASE=$SUGGESTED_RELEASE" >> $GITHUB_OUTPUT

      - name: Generate enhanced description
        id: generate_description
        run: |
          COMMITS="${{ steps.analyze.outputs.COMMITS }}"
          COMMIT_COUNT="${{ steps.analyze.outputs.COMMIT_COUNT }}"
          FEAT_COUNT="${{ steps.analyze.outputs.FEAT_COUNT }}"
          FIX_COUNT="${{ steps.analyze.outputs.FIX_COUNT }}"
          DOCS_COUNT="${{ steps.analyze.outputs.DOCS_COUNT }}"
          CHORE_COUNT="${{ steps.analyze.outputs.CHORE_COUNT }}"
          REFACTOR_COUNT="${{ steps.analyze.outputs.REFACTOR_COUNT }}"
          TEST_COUNT="${{ steps.analyze.outputs.TEST_COUNT }}"
          BREAKING_COUNT="${{ steps.analyze.outputs.BREAKING_COUNT }}"
          FILES_CHANGED="${{ steps.analyze.outputs.FILES_CHANGED }}"
          ADDITIONS="${{ steps.analyze.outputs.ADDITIONS }}"
          DELETIONS="${{ steps.analyze.outputs.DELETIONS }}"
          SRC_FILES="${{ steps.analyze.outputs.SRC_FILES }}"
          TEST_FILES="${{ steps.analyze.outputs.TEST_FILES }}"
          DOCS_FILES="${{ steps.analyze.outputs.DOCS_FILES }}"
          CONFIG_FILES="${{ steps.analyze.outputs.CONFIG_FILES }}"
          SUGGESTED_RELEASE="${{ steps.analyze.outputs.SUGGESTED_RELEASE }}"

          # Badge de breaking change
          BREAKING_BADGE=""
          if [ "$BREAKING_COUNT" -gt 0 ]; then
            BREAKING_BADGE="
          > ‚ö†Ô∏è **BREAKING CHANGES** detected! Review carefully before merging.
          "
          fi

          # G√©n√©rer le commentaire
          COMMENT=$(cat <<EOF
          ## üìä PR Analysis

          $BREAKING_BADGE

          ### üìà Statistics

          | Metric | Count |
          |--------|-------|
          | Total Commits | $COMMIT_COUNT |
          | Files Changed | $FILES_CHANGED |
          | Lines Added | +$ADDITIONS |
          | Lines Deleted | -$DELETIONS |

          ### üè∑Ô∏è Commit Types

          | Type | Count | Description |
          |------|-------|-------------|
          | ‚ú® Features | $FEAT_COUNT | New features |
          | üêõ Fixes | $FIX_COUNT | Bug fixes |
          | üìö Docs | $DOCS_COUNT | Documentation changes |
          | üîß Chore | $CHORE_COUNT | Maintenance tasks |
          | ‚ôªÔ∏è Refactor | $REFACTOR_COUNT | Code refactoring |
          | ‚úÖ Tests | $TEST_COUNT | Test additions/changes |
          | üí• Breaking | $BREAKING_COUNT | Breaking changes |

          ### üìÅ Files by Category

          | Category | Count |
          |----------|-------|
          | Source Files | $SRC_FILES |
          | Test Files | $TEST_FILES |
          | Documentation | $DOCS_FILES |
          | Config Files | $CONFIG_FILES |

          ### üéØ Suggested Release Type

          Based on commit analysis: **$SUGGESTED_RELEASE**

          <details>
          <summary>üìù View all commits ($COMMIT_COUNT)</summary>

          $COMMITS

          </details>

          ---

          <sub>ü§ñ Auto-generated by enhance-pr-description workflow</sub>
          EOF
          )

          # Sauvegarder dans un fichier pour √©viter les probl√®mes d'√©chappement
          echo "$COMMENT" > pr_comment.md

      - name: Add comment to PR
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          PR_NUMBER="${{ steps.pr_details.outputs.PR_NUMBER }}"
          gh pr comment $PR_NUMBER --body-file pr_comment.md

      - name: Add labels based on analysis
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          PR_NUMBER="${{ steps.pr_details.outputs.PR_NUMBER }}"
          SUGGESTED_RELEASE="${{ steps.analyze.outputs.SUGGESTED_RELEASE }}"
          BREAKING_COUNT="${{ steps.analyze.outputs.BREAKING_COUNT }}"
          FEAT_COUNT="${{ steps.analyze.outputs.FEAT_COUNT }}"
          FIX_COUNT="${{ steps.analyze.outputs.FIX_COUNT }}"
          DOCS_COUNT="${{ steps.analyze.outputs.DOCS_COUNT }}"

          # Labels √† ajouter
          LABELS=""

          # Release type
          if [ "$SUGGESTED_RELEASE" = "major" ]; then
            LABELS="$LABELS release:major"
          elif [ "$SUGGESTED_RELEASE" = "minor" ]; then
            LABELS="$LABELS release:minor"
          else
            LABELS="$LABELS release:patch"
          fi

          # Breaking changes
          if [ "$BREAKING_COUNT" -gt 0 ]; then
            LABELS="$LABELS breaking-change"
          fi

          # Type principal
          if [ "$FEAT_COUNT" -gt 0 ]; then
            LABELS="$LABELS enhancement"
          fi
          if [ "$FIX_COUNT" -gt 0 ]; then
            LABELS="$LABELS bug"
          fi
          if [ "$DOCS_COUNT" -gt 0 ]; then
            LABELS="$LABELS documentation"
          fi

          # Ajouter les labels
          if [ -n "$LABELS" ]; then
            gh pr edit $PR_NUMBER --add-label "$LABELS"
          fi

      - name: Summary
        run: |
          echo "## ‚úÖ PR Description Enhanced" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Commits Analyzed**: ${{ steps.analyze.outputs.COMMIT_COUNT }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Files Changed**: ${{ steps.analyze.outputs.FILES_CHANGED }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Suggested Release**: ${{ steps.analyze.outputs.SUGGESTED_RELEASE }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "[View PR #${{ steps.pr_details.outputs.PR_NUMBER }}](https://github.com/${{ github.repository }}/pull/${{ steps.pr_details.outputs.PR_NUMBER }})" >> $GITHUB_STEP_SUMMARY
