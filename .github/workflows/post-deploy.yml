name: Post-Deploy Release

on:
  # Trigger apr√®s un push sur main (succ√®s du d√©ploiement)
  push:
    branches:
      - main
    # Ignore version bump commits to prevent loops
    paths-ignore:
      - 'package.json'
      - 'CHANGELOG.md'

  # Ou trigger manuel depuis GitHub UI
  workflow_dispatch:
    inputs:
      release_type:
        description: 'Type de release'
        required: true
        type: choice
        options:
          - patch
          - minor
          - major
        default: 'patch'

permissions:
  contents: write
  pull-requests: write

jobs:
  # Job 0: Check if we should run (prevents "failed" status on develop)
  validate-branch:
    runs-on: ubuntu-latest
    outputs:
      should_run: ${{ steps.check.outputs.should_run }}

    steps:
      - name: Check if running on main branch
        id: check
        run: |
          if [ "${{ github.ref }}" = "refs/heads/main" ]; then
            echo "should_run=true" >> $GITHUB_OUTPUT
            echo "‚úÖ Running on main branch"
          else
            echo "should_run=false" >> $GITHUB_OUTPUT
            echo "‚è≠Ô∏è Skipping - only runs on main branch (current: ${{ github.ref }})"
          fi

  # Job 1: V√©rifier que nous sommes sur main
  check-deploy:
    runs-on: ubuntu-latest
    needs: [validate-branch]
    if: github.event_name == 'push' && needs.validate-branch.outputs.should_run == 'true'
    outputs:
      should_release: ${{ steps.check.outputs.should_release }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Check if deploy should trigger release
        id: check
        run: |
          # V√©rifier si le dernier commit n'est pas d√©j√† un bump de version
          LAST_COMMIT=$(git log -1 --pretty=%B)
          if echo "$LAST_COMMIT" | grep -q "chore(release): bump version"; then
            echo "‚è≠Ô∏è  Skipping release - last commit was a version bump"
            echo "should_release=false" >> $GITHUB_OUTPUT
          else
            echo "‚úÖ Ready for release"
            echo "should_release=true" >> $GITHUB_OUTPUT
          fi

  # Job 2: Proposer une release (d√©clench√© manuellement ou automatiquement)
  propose-release:
    runs-on: ubuntu-latest
    needs: [validate-branch, check-deploy]
    if: |
      github.event_name == 'workflow_dispatch' ||
      (needs.validate-branch.outputs.should_run == 'true' &&
       needs.check-deploy.outputs.should_release == 'true')

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          registry-url: 'https://registry.npmjs.org'

      - name: Configure Git
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

      - name: Get Current Version
        id: current_version
        run: |
          VERSION=$(node -p "require('./package.json').version")
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "üì¶ Current version: $VERSION"

      - name: Determine Release Type
        id: release_type
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            TYPE="${{ inputs.release_type }}"
          else
            # Auto-detect depuis le dernier commit message
            COMMIT_MSG=$(git log -1 --pretty=%B)
            if echo "$COMMIT_MSG" | grep -qiE '^(feat|feature)(\(.*\))?!:|BREAKING CHANGE:'; then
              TYPE="major"
            elif echo "$COMMIT_MSG" | grep -qiE '^(feat|feature)(\(.*\))?:'; then
              TYPE="minor"
            else
              TYPE="patch"
            fi
          fi
          echo "type=$TYPE" >> $GITHUB_OUTPUT
          echo "üè∑Ô∏è  Release type: $TYPE"

      - name: Bump Version
        id: bump
        run: |
          TYPE="${{ steps.release_type.outputs.type }}"

          # Bump version in package.json
          npm version $TYPE --no-git-tag-version

          NEW_VERSION=$(node -p "require('./package.json').version")
          echo "new_version=$NEW_VERSION" >> $GITHUB_OUTPUT
          echo "üì¶ New version: $NEW_VERSION"

      - name: Update CHANGELOG
        run: |
          VERSION="${{ steps.bump.outputs.new_version }}"
          DATE=$(date +%Y-%m-%d)

          # Cr√©er le header du changelog
          cat > CHANGELOG.tmp << 'EOFCHANGELOG'
# Changelog

## [VERSION_PLACEHOLDER] - DATE_PLACEHOLDER

### Added
- Features from this release

### Changed
- Improvements from this release

### Fixed
- Bug fixes from this release

---

EOFCHANGELOG

          # Remplacer les placeholders (compatible Linux)
          sed -i "s/VERSION_PLACEHOLDER/$VERSION/g" CHANGELOG.tmp
          sed -i "s/DATE_PLACEHOLDER/$DATE/g" CHANGELOG.tmp

          # Ajouter l'ancien changelog s'il existe
          if [ -f CHANGELOG.md ]; then
            tail -n +2 CHANGELOG.md >> CHANGELOG.tmp
          fi

          mv CHANGELOG.tmp CHANGELOG.md

          echo "‚úÖ CHANGELOG updated for version $VERSION"

      - name: Commit Version Bump
        run: |
          VERSION="${{ steps.bump.outputs.new_version }}"

          git add package.json CHANGELOG.md
          git commit -m "chore(release): bump version to $VERSION

          Co-Authored-By: Claude Sonnet 4.5 <noreply@anthropic.com>"

          git push origin main

          echo "‚úÖ Version bumped and pushed to main"

      - name: Create Git Tag
        run: |
          VERSION="${{ steps.bump.outputs.new_version }}"

          git tag -a "v$VERSION" -m "Release v$VERSION"
          git push origin "v$VERSION"

          echo "üè∑Ô∏è  Tag v$VERSION created and pushed"

      - name: Generate Release Notes
        id: release_notes
        run: |
          VERSION="${{ steps.bump.outputs.new_version }}"
          PREV_TAG=$(git describe --abbrev=0 --tags HEAD~1 2>/dev/null || echo "")

          if [ -z "$PREV_TAG" ]; then
            COMMITS=$(git log --pretty=format:"- %s (%h)" -20)
          else
            COMMITS=$(git log --pretty=format:"- %s (%h)" $PREV_TAG..HEAD)
          fi

          # Extraire du CHANGELOG
          CHANGELOG_SECTION=$(awk '/^## \['$VERSION'\]/,/^## \[|^---/{print}' CHANGELOG.md | head -n -1)

          # Cr√©er les notes de release
          {
            echo "## üöÄ Release v$VERSION"
            echo ""
            echo "$CHANGELOG_SECTION"
            echo ""
            echo "### üìù Commits"
            echo ""
            echo "$COMMITS"
            echo ""
            echo "### üì¶ Installation"
            echo ""
            echo '```bash'
            echo "npm install pulse-js-framework@$VERSION"
            echo '```'
            echo ""
            echo "### üîó Links"
            echo ""
            echo "- [Documentation](https://pulse-js.fr)"
            echo "- [Changelog](https://github.com/vincenthirtz/pulse-js-framework/blob/main/CHANGELOG.md)"
          } > release_notes.md

          echo "notes_file=release_notes.md" >> $GITHUB_OUTPUT

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ steps.bump.outputs.new_version }}
          name: Release v${{ steps.bump.outputs.new_version }}
          body_path: ${{ steps.release_notes.outputs.notes_file }}
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Success Summary
        run: |
          VERSION="${{ steps.bump.outputs.new_version }}"
          TYPE="${{ steps.release_type.outputs.type }}"

          echo "## üéâ Release Success" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Type**: $TYPE" >> $GITHUB_STEP_SUMMARY
          echo "- **Version**: $VERSION" >> $GITHUB_STEP_SUMMARY
          echo "- **Tag**: v$VERSION" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit**: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### üì¶ Next Steps" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "1. ‚úÖ Version bumped in package.json" >> $GITHUB_STEP_SUMMARY
          echo "2. ‚úÖ CHANGELOG.md updated" >> $GITHUB_STEP_SUMMARY
          echo "3. ‚úÖ Git tag created and pushed" >> $GITHUB_STEP_SUMMARY
          echo "4. ‚úÖ GitHub Release created" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### üîó Links" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- [Release Page](https://github.com/vincenthirtz/pulse-js-framework/releases/tag/v$VERSION)" >> $GITHUB_STEP_SUMMARY
          echo "- [Documentation](https://pulse-js.fr)" >> $GITHUB_STEP_SUMMARY

  # Job 3: Provide workflow status (prevents "failed" when skipped)
  workflow-status:
    runs-on: ubuntu-latest
    needs: [validate-branch, check-deploy, propose-release]
    if: always()

    steps:
      - name: Determine Workflow Status
        run: |
          if [ "${{ needs.validate-branch.outputs.should_run }}" != "true" ]; then
            echo "‚ÑπÔ∏è Workflow skipped - not running on main branch"
            exit 0
          elif [ "${{ needs.check-deploy.outputs.should_release }}" != "true" ]; then
            echo "‚ÑπÔ∏è Workflow skipped - last commit was a version bump"
            exit 0
          elif [ "${{ needs.propose-release.result }}" = "success" ]; then
            echo "‚úÖ Release workflow completed successfully"
            exit 0
          elif [ "${{ needs.propose-release.result }}" = "skipped" ]; then
            echo "‚ÑπÔ∏è Release workflow was skipped"
            exit 0
          else
            echo "‚ùå Release workflow failed"
            exit 1
          fi

  # Job 4: Publier sur npm (optionnel, comment√© par d√©faut)
  # publish-npm:
  #   runs-on: ubuntu-latest
  #   needs: [propose-release]
  #   if: success()
  #
  #   steps:
  #     - name: Checkout
  #       uses: actions/checkout@v4
  #       with:
  #         ref: main
  #
  #     - name: Setup Node.js
  #       uses: actions/setup-node@v4
  #       with:
  #         node-version: '18'
  #         registry-url: 'https://registry.npmjs.org'
  #
  #     - name: Publish to npm
  #       run: npm publish
  #       env:
  #         NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
  #
  #     - name: Publish Success
  #       run: |
  #         VERSION=$(node -p "require('./package.json').version")
  #         echo "‚úÖ Published pulse-js-framework@$VERSION to npm"
