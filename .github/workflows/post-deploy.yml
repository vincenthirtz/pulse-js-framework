name: Post-Deploy Release

on:
  # Trigger aprÃ¨s un push sur main (succÃ¨s du dÃ©ploiement)
  push:
    branches:
      - main

  # Ou trigger manuel depuis GitHub UI
  workflow_dispatch:
    inputs:
      release_type:
        description: 'Type de release'
        required: true
        type: choice
        options:
          - patch
          - minor
          - major
        default: 'patch'

permissions:
  contents: write
  pull-requests: write

jobs:
  # Job 1: Attendre la confirmation du dÃ©ploiement Netlify
  wait-for-deploy:
    runs-on: ubuntu-latest
    if: github.event_name == 'push'
    outputs:
      deploy_url: ${{ steps.netlify.outputs.deploy_url }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Wait for Netlify Deploy
        id: netlify
        uses: nwtgck/actions-netlify@v2
        with:
          publish-dir: 'dist'
          production-deploy: true
          github-token: ${{ secrets.GITHUB_TOKEN }}
          enable-pull-request-comment: false
          enable-commit-comment: false
          overwrites-pull-request-comment: false
        timeout-minutes: 15

      - name: Check Deploy Status
        if: steps.netlify.outputs.deploy-url == ''
        run: |
          echo "âŒ Netlify deploy failed or timed out"
          exit 1

      - name: Deploy Success
        run: |
          echo "âœ… Netlify deploy succeeded"
          echo "ðŸŒ Deploy URL: ${{ steps.netlify.outputs.deploy-url }}"

  # Job 2: Proposer une release (dÃ©clenchÃ© manuellement ou automatiquement)
  propose-release:
    runs-on: ubuntu-latest
    needs: [wait-for-deploy]
    if: |
      always() &&
      (github.event_name == 'workflow_dispatch' ||
       (github.event_name == 'push' && needs.wait-for-deploy.result == 'success'))

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          registry-url: 'https://registry.npmjs.org'

      - name: Configure Git
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

      - name: Get Current Version
        id: current_version
        run: |
          VERSION=$(node -p "require('./package.json').version")
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "ðŸ“¦ Current version: $VERSION"

      - name: Determine Release Type
        id: release_type
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            TYPE="${{ inputs.release_type }}"
          else
            # Auto-detect depuis le dernier commit message
            COMMIT_MSG=$(git log -1 --pretty=%B)
            if echo "$COMMIT_MSG" | grep -qiE '^(feat|feature)(\(.*\))?!:|BREAKING CHANGE:'; then
              TYPE="major"
            elif echo "$COMMIT_MSG" | grep -qiE '^(feat|feature)(\(.*\))?:'; then
              TYPE="minor"
            else
              TYPE="patch"
            fi
          fi
          echo "type=$TYPE" >> $GITHUB_OUTPUT
          echo "ðŸ·ï¸  Release type: $TYPE"

      - name: Bump Version
        id: bump
        run: |
          TYPE="${{ steps.release_type.outputs.type }}"

          # Bump version in package.json
          npm version $TYPE --no-git-tag-version

          NEW_VERSION=$(node -p "require('./package.json').version")
          echo "new_version=$NEW_VERSION" >> $GITHUB_OUTPUT
          echo "ðŸ“¦ New version: $NEW_VERSION"

      - name: Update CHANGELOG
        run: |
          VERSION="${{ steps.bump.outputs.new_version }}"
          DATE=$(date +%Y-%m-%d)

          # CrÃ©er le header du changelog
          cat > CHANGELOG.tmp << EOF
# Changelog

## [$VERSION] - $DATE

### Added
- Features from this release

### Changed
- Improvements from this release

### Fixed
- Bug fixes from this release

---

EOF

          # Ajouter l'ancien changelog s'il existe
          if [ -f CHANGELOG.md ]; then
            tail -n +2 CHANGELOG.md >> CHANGELOG.tmp
          fi

          mv CHANGELOG.tmp CHANGELOG.md

          echo "âœ… CHANGELOG updated for version $VERSION"

      - name: Commit Version Bump
        run: |
          VERSION="${{ steps.bump.outputs.new_version }}"

          git add package.json CHANGELOG.md
          git commit -m "chore(release): bump version to $VERSION

          Co-Authored-By: Claude Sonnet 4.5 <noreply@anthropic.com>"

          git push origin main

          echo "âœ… Version bumped and pushed to main"

      - name: Create Git Tag
        run: |
          VERSION="${{ steps.bump.outputs.new_version }}"

          git tag -a "v$VERSION" -m "Release v$VERSION"
          git push origin "v$VERSION"

          echo "ðŸ·ï¸  Tag v$VERSION created and pushed"

      - name: Generate Release Notes
        id: release_notes
        run: |
          VERSION="${{ steps.bump.outputs.new_version }}"
          PREV_TAG=$(git describe --abbrev=0 --tags HEAD~1 2>/dev/null || echo "")

          if [ -z "$PREV_TAG" ]; then
            COMMITS=$(git log --pretty=format:"- %s (%h)" -20)
          else
            COMMITS=$(git log --pretty=format:"- %s (%h)" $PREV_TAG..HEAD)
          fi

          # Extraire du CHANGELOG
          CHANGELOG_SECTION=$(awk '/^## \['$VERSION'\]/,/^## \[|^---/{print}' CHANGELOG.md | head -n -1)

          cat > release_notes.md << EOF
          ## ðŸš€ Release v$VERSION

          $CHANGELOG_SECTION

          ### ðŸ“ Commits

          $COMMITS

          ### ðŸ“¦ Installation

          \`\`\`bash
          npm install pulse-js-framework@$VERSION
          \`\`\`

          ### ðŸ”— Links

          - [Documentation](https://pulse-js.fr)
          - [Changelog](https://github.com/vincenthirtz/pulse-js-framework/blob/main/CHANGELOG.md)
          EOF

          echo "notes_file=release_notes.md" >> $GITHUB_OUTPUT

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ steps.bump.outputs.new_version }}
          name: Release v${{ steps.bump.outputs.new_version }}
          body_path: ${{ steps.release_notes.outputs.notes_file }}
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Success Summary
        run: |
          VERSION="${{ steps.bump.outputs.new_version }}"
          TYPE="${{ steps.release_type.outputs.type }}"

          echo "## ðŸŽ‰ Release Success" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Type**: $TYPE" >> $GITHUB_STEP_SUMMARY
          echo "- **Version**: $VERSION" >> $GITHUB_STEP_SUMMARY
          echo "- **Tag**: v$VERSION" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit**: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“¦ Next Steps" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "1. âœ… Version bumped in package.json" >> $GITHUB_STEP_SUMMARY
          echo "2. âœ… CHANGELOG.md updated" >> $GITHUB_STEP_SUMMARY
          echo "3. âœ… Git tag created and pushed" >> $GITHUB_STEP_SUMMARY
          echo "4. âœ… GitHub Release created" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ”— Links" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- [Release Page](https://github.com/vincenthirtz/pulse-js-framework/releases/tag/v$VERSION)" >> $GITHUB_STEP_SUMMARY
          echo "- [Documentation](https://pulse-js.fr)" >> $GITHUB_STEP_SUMMARY

  # Job 3: Publier sur npm (optionnel, commentÃ© par dÃ©faut)
  # publish-npm:
  #   runs-on: ubuntu-latest
  #   needs: [propose-release]
  #   if: success()
  #
  #   steps:
  #     - name: Checkout
  #       uses: actions/checkout@v4
  #       with:
  #         ref: main
  #
  #     - name: Setup Node.js
  #       uses: actions/setup-node@v4
  #       with:
  #         node-version: '18'
  #         registry-url: 'https://registry.npmjs.org'
  #
  #     - name: Publish to npm
  #       run: npm publish
  #       env:
  #         NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
  #
  #     - name: Publish Success
  #       run: |
  #         VERSION=$(node -p "require('./package.json').version")
  #         echo "âœ… Published pulse-js-framework@$VERSION to npm"
