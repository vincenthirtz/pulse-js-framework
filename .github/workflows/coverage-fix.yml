name: Auto-Generate Missing Tests

on:
  workflow_run:
    workflows: ["CI"]
    types:
      - completed
  workflow_dispatch:  # Allow manual trigger

permissions:
  contents: write
  pull-requests: write

jobs:
  coverage-fix:
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' || github.event_name == 'workflow_dispatch' }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: ${{ github.head_ref || github.ref_name }}
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run tests with coverage
        run: npm test -- --coverage
        continue-on-error: true

      - name: Install Claude Code CLI
        run: |
          # Install Claude Code globally
          npm install -g @anthropic/claude-code

          # Configure Claude CLI with API key
          echo "${{ secrets.ANTHROPIC_API_KEY }}" | claude auth login --api-key

      - name: Download coverage report
        uses: actions/download-artifact@v4
        with:
          name: coverage-report
          path: coverage/
        continue-on-error: true

      - name: Generate missing tests with Claude
        id: generate-tests
        run: |
          # Check if coverage report exists
          if [ ! -f coverage/lcov.info ]; then
            echo "No coverage report found, generating one..."
            npm test -- --coverage
          fi

          # Run Claude Code to generate tests
          claude -p "Read the Codecov report at coverage/lcov.info, identify uncovered lines in runtime/, and write targeted tests using node:test. Focus on the top 5 files with lowest coverage. For each file:
          1. Identify uncovered lines and branches
          2. Write focused unit tests that cover those lines
          3. Use descriptive test names
          4. Follow existing test patterns in test/ directory
          5. Run tests to verify they pass
          After generating tests, report which files were improved and the new coverage percentages." \
          --allowedTools "Read,Write,Edit,Bash,Grep,Glob" \
          --output coverage-fix-report.md

      - name: Run new tests
        run: npm test
        continue-on-error: true

      - name: Generate updated coverage
        run: npm test -- --coverage

      - name: Check for changes
        id: check-changes
        run: |
          if git diff --quiet test/; then
            echo "has_changes=false" >> $GITHUB_OUTPUT
          else
            echo "has_changes=true" >> $GITHUB_OUTPUT
          fi

      - name: Create Pull Request
        if: steps.check-changes.outputs.has_changes == 'true'
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "test: auto-generate missing tests for uncovered code"
          title: "ðŸ¤– Auto-generated tests for improved coverage"
          body: |
            ## Automated Test Generation

            This PR was automatically generated by Claude Code to improve test coverage.

            ### Changes
            - Generated tests for previously uncovered code in `runtime/`
            - Focused on files with lowest coverage
            - All new tests verified to pass

            ### Coverage Report
            $(cat coverage-fix-report.md || echo "Report not available")

            ### Review Checklist
            - [ ] Review generated tests for correctness
            - [ ] Ensure tests follow project conventions
            - [ ] Verify coverage improvements
            - [ ] Check for edge cases

            **Note**: This is an automated PR. Please review carefully before merging.
          branch: auto-coverage-fix-${{ github.run_number }}
          labels: |
            automated
            tests
            coverage
          assignees: ${{ github.actor }}

      - name: Comment on workflow run
        if: steps.check-changes.outputs.has_changes == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.repos.createCommitComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              commit_sha: context.sha,
              body: 'ðŸ¤– Auto-generated tests created. See PR for details.'
            })

      - name: Upload coverage artifacts
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report-updated
          path: coverage/
          retention-days: 7
