name: Promote to Main

on:
  workflow_dispatch:
    inputs:
      version_type:
        description: 'Release version type (will create release after merge)'
        required: false
        type: choice
        options:
          - none
          - patch
          - minor
          - major
        default: 'none'

permissions:
  contents: write
  pull-requests: write

jobs:
  create-pr:
    name: Create PR develop -> main
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check if PR already exists
        id: check_pr
        run: |
          EXISTING_PR=$(gh pr list --base main --head develop --state open --json number --jq '.[0].number')
          if [ -n "$EXISTING_PR" ]; then
            echo "PR already exists: #$EXISTING_PR"
            echo "PR_EXISTS=true" >> $GITHUB_OUTPUT
            echo "PR_NUMBER=$EXISTING_PR" >> $GITHUB_OUTPUT
          else
            echo "No existing PR found"
            echo "PR_EXISTS=false" >> $GITHUB_OUTPUT
          fi
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Get commits since last release
        if: steps.check_pr.outputs.PR_EXISTS == 'false'
        id: get_commits
        run: |
          # Get last tag on main
          LAST_TAG=$(git describe --tags --abbrev=0 origin/main 2>/dev/null || echo "")

          if [ -z "$LAST_TAG" ]; then
            COMMITS=$(git log origin/develop --pretty=format:"- %s (%h)" --no-merges -20)
          else
            COMMITS=$(git log ${LAST_TAG}..origin/develop --pretty=format:"- %s (%h)" --no-merges)
          fi

          # Save commits to file (avoids shell injection when building PR body)
          echo "$COMMITS" > /tmp/commits.txt

          COMMIT_COUNT=$(echo "$COMMITS" | wc -l | tr -d ' ')

          # Stats by commit type (Conventional Commits)
          FEAT_COUNT=$(echo "$COMMITS" | grep -c "^- feat" || echo 0)
          FIX_COUNT=$(echo "$COMMITS" | grep -c "^- fix" || echo 0)
          DOCS_COUNT=$(echo "$COMMITS" | grep -c "^- docs" || echo 0)
          CHORE_COUNT=$(echo "$COMMITS" | grep -c "^- chore" || echo 0)
          REFACTOR_COUNT=$(echo "$COMMITS" | grep -c "^- refactor" || echo 0)
          TEST_COUNT=$(echo "$COMMITS" | grep -c "^- test" || echo 0)
          BREAKING_COUNT=$(echo "$COMMITS" | grep -c "!" || echo 0)

          # Files changed
          if [ -z "$LAST_TAG" ]; then
            FILES_CHANGED=$(git diff --name-only origin/main...origin/develop | wc -l | tr -d ' ')
            ADDITIONS=$(git diff --shortstat origin/main...origin/develop | grep -oE '[0-9]+ insertion' | grep -oE '[0-9]+' || echo 0)
            DELETIONS=$(git diff --shortstat origin/main...origin/develop | grep -oE '[0-9]+ deletion' | grep -oE '[0-9]+' || echo 0)
          else
            FILES_CHANGED=$(git diff --name-only ${LAST_TAG}..origin/develop | wc -l | tr -d ' ')
            ADDITIONS=$(git diff --shortstat ${LAST_TAG}..origin/develop | grep -oE '[0-9]+ insertion' | grep -oE '[0-9]+' || echo 0)
            DELETIONS=$(git diff --shortstat ${LAST_TAG}..origin/develop | grep -oE '[0-9]+ deletion' | grep -oE '[0-9]+' || echo 0)
          fi

          # Suggested release type
          SUGGESTED_RELEASE="patch"
          if [ "$BREAKING_COUNT" -gt 0 ]; then
            SUGGESTED_RELEASE="major"
          elif [ "$FEAT_COUNT" -gt 0 ]; then
            SUGGESTED_RELEASE="minor"
          fi

          echo "COMMIT_COUNT=$COMMIT_COUNT" >> $GITHUB_OUTPUT
          echo "LAST_TAG=$LAST_TAG" >> $GITHUB_OUTPUT
          echo "FEAT_COUNT=$FEAT_COUNT" >> $GITHUB_OUTPUT
          echo "FIX_COUNT=$FIX_COUNT" >> $GITHUB_OUTPUT
          echo "DOCS_COUNT=$DOCS_COUNT" >> $GITHUB_OUTPUT
          echo "CHORE_COUNT=$CHORE_COUNT" >> $GITHUB_OUTPUT
          echo "REFACTOR_COUNT=$REFACTOR_COUNT" >> $GITHUB_OUTPUT
          echo "TEST_COUNT=$TEST_COUNT" >> $GITHUB_OUTPUT
          echo "BREAKING_COUNT=$BREAKING_COUNT" >> $GITHUB_OUTPUT
          echo "FILES_CHANGED=$FILES_CHANGED" >> $GITHUB_OUTPUT
          echo "ADDITIONS=$ADDITIONS" >> $GITHUB_OUTPUT
          echo "DELETIONS=$DELETIONS" >> $GITHUB_OUTPUT
          echo "SUGGESTED_RELEASE=$SUGGESTED_RELEASE" >> $GITHUB_OUTPUT

      - name: Build PR body
        if: steps.check_pr.outputs.PR_EXISTS == 'false'
        run: |
          COMMIT_COUNT="${{ steps.get_commits.outputs.COMMIT_COUNT }}"
          FEAT_COUNT="${{ steps.get_commits.outputs.FEAT_COUNT }}"
          FIX_COUNT="${{ steps.get_commits.outputs.FIX_COUNT }}"
          DOCS_COUNT="${{ steps.get_commits.outputs.DOCS_COUNT }}"
          CHORE_COUNT="${{ steps.get_commits.outputs.CHORE_COUNT }}"
          REFACTOR_COUNT="${{ steps.get_commits.outputs.REFACTOR_COUNT }}"
          TEST_COUNT="${{ steps.get_commits.outputs.TEST_COUNT }}"
          BREAKING_COUNT="${{ steps.get_commits.outputs.BREAKING_COUNT }}"
          FILES_CHANGED="${{ steps.get_commits.outputs.FILES_CHANGED }}"
          ADDITIONS="${{ steps.get_commits.outputs.ADDITIONS }}"
          DELETIONS="${{ steps.get_commits.outputs.DELETIONS }}"
          SUGGESTED_RELEASE="${{ steps.get_commits.outputs.SUGGESTED_RELEASE }}"

          # Read commits safely from file
          COMMITS=$(cat /tmp/commits.txt)

          # Determine version type message BEFORE using it
          VERSION_TYPE_MSG="Manual release creation required"
          if [ "${{ inputs.version_type }}" != "none" ]; then
            VERSION_TYPE_MSG="Release workflow will be triggered automatically (${{ inputs.version_type }})"
          fi

          # Breaking change badge
          BREAKING_BADGE=""
          if [ "$BREAKING_COUNT" -gt 0 ]; then
            BREAKING_BADGE="> **WARNING**: This PR contains $BREAKING_COUNT breaking change(s)!"
          fi

          # Build PR body to file (safe: no ${{ }} interpolation of commit messages)
          {
            echo "## Promote develop to main"
            echo ""
            echo "This PR promotes the current \`develop\` branch to \`main\` for production deployment."
            echo ""
            if [ -n "$BREAKING_BADGE" ]; then
              echo "$BREAKING_BADGE"
              echo ""
            fi
            echo "### Statistics"
            echo ""
            echo "| Metric | Count |"
            echo "|--------|-------|"
            echo "| Total Commits | ${COMMIT_COUNT} |"
            echo "| Files Changed | ${FILES_CHANGED} |"
            echo "| Lines Added | +${ADDITIONS} |"
            echo "| Lines Deleted | -${DELETIONS} |"
            echo ""
            echo "### Commit Types"
            echo ""
            echo "| Type | Count |"
            echo "|------|-------|"
            echo "| Features | ${FEAT_COUNT} |"
            echo "| Fixes | ${FIX_COUNT} |"
            echo "| Docs | ${DOCS_COUNT} |"
            echo "| Chore | ${CHORE_COUNT} |"
            echo "| Refactor | ${REFACTOR_COUNT} |"
            echo "| Tests | ${TEST_COUNT} |"
            echo "| Breaking | ${BREAKING_COUNT} |"
            echo ""
            echo "### Suggested Release"
            echo ""
            echo "Based on commit analysis: **${SUGGESTED_RELEASE}**"
            echo ""
            echo "<details>"
            echo "<summary>View all commits (${COMMIT_COUNT})</summary>"
            echo ""
            echo "$COMMITS"
            echo ""
            echo "</details>"
            echo ""
            echo "### Pre-merge Checklist"
            echo ""
            echo "- [ ] All CI checks passing"
            echo "- [ ] Staging deployment tested"
            echo "- [ ] Breaking changes documented (if any)"
            echo "- [ ] Version bumped appropriately"
            echo ""
            echo "### Post-merge Actions"
            echo ""
            echo "After merging this PR:"
            echo "1. Production will be deployed to Netlify automatically"
            echo "2. ${VERSION_TYPE_MSG}"
            echo ""
            echo "---"
            echo ""
            echo "**Staging URL**: https://staging--pulse-js.netlify.app"
            echo "**Production URL**: https://pulse-js.fr"
            echo ""
            echo "<sub>Auto-generated by promote-to-main workflow</sub>"
          } > /tmp/pr_body.md

      - name: Create Pull Request
        if: steps.check_pr.outputs.PR_EXISTS == 'false'
        id: create_pr
        run: |
          LAST_TAG="${{ steps.get_commits.outputs.LAST_TAG }}"

          if [ -n "$LAST_TAG" ]; then
            TITLE="Release: Promote develop to main (since $LAST_TAG)"
          else
            TITLE="Release: Promote develop to main (initial release)"
          fi

          PR_URL=$(gh pr create \
            --base main \
            --head develop \
            --title "$TITLE" \
            --body-file /tmp/pr_body.md \
            --label "release")

          echo "PR_URL=$PR_URL" >> $GITHUB_OUTPUT
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Add comment to existing PR
        if: steps.check_pr.outputs.PR_EXISTS == 'true'
        run: |
          PR_NUMBER="${{ steps.check_pr.outputs.PR_NUMBER }}"
          gh pr comment $PR_NUMBER --body "Workflow re-run requested. Please review changes."
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Create summary
        run: |
          if [ "${{ steps.check_pr.outputs.PR_EXISTS }}" == "true" ]; then
            echo "## PR Already Exists" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "A PR from \`develop\` to \`main\` already exists:" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "[View PR #${{ steps.check_pr.outputs.PR_NUMBER }}](https://github.com/${{ github.repository }}/pull/${{ steps.check_pr.outputs.PR_NUMBER }})" >> $GITHUB_STEP_SUMMARY
          else
            echo "## PR Created Successfully" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**PR URL**: ${{ steps.create_pr.outputs.PR_URL }}" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Commits**: ${{ steps.get_commits.outputs.COMMIT_COUNT }}" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            if [ "${{ inputs.version_type }}" != "none" ]; then
              echo "**Release Type**: ${{ inputs.version_type }}" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "After merge, a ${{ inputs.version_type }} release will be created automatically" >> $GITHUB_STEP_SUMMARY
            fi
          fi
