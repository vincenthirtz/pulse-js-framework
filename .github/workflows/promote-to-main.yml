name: Promote to Main

on:
  workflow_dispatch:
    inputs:
      version_type:
        description: 'Release version type (will create release after merge)'
        required: false
        type: choice
        options:
          - none
          - patch
          - minor
          - major
        default: 'none'

jobs:
  create-pr:
    name: Create PR develop ‚Üí main
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check if PR already exists
        id: check_pr
        run: |
          EXISTING_PR=$(gh pr list --base main --head develop --state open --json number --jq '.[0].number')
          if [ -n "$EXISTING_PR" ]; then
            echo "PR already exists: #$EXISTING_PR"
            echo "PR_EXISTS=true" >> $GITHUB_OUTPUT
            echo "PR_NUMBER=$EXISTING_PR" >> $GITHUB_OUTPUT
          else
            echo "No existing PR found"
            echo "PR_EXISTS=false" >> $GITHUB_OUTPUT
          fi
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Get commits since last release
        if: steps.check_pr.outputs.PR_EXISTS == 'false'
        id: get_commits
        run: |
          # Get last tag on main
          LAST_TAG=$(git describe --tags --abbrev=0 origin/main 2>/dev/null || echo "")

          if [ -z "$LAST_TAG" ]; then
            # No tags yet, get all commits
            COMMITS=$(git log origin/develop --pretty=format:"- %s (%h)" --no-merges -20)
          else
            # Get commits since last tag
            COMMITS=$(git log ${LAST_TAG}..origin/develop --pretty=format:"- %s (%h)" --no-merges)
          fi

          # Count commits
          COMMIT_COUNT=$(echo "$COMMITS" | wc -l | tr -d ' ')

          # Stats par type de commit (Conventional Commits)
          FEAT_COUNT=$(echo "$COMMITS" | grep -c "^- feat" || echo 0)
          FIX_COUNT=$(echo "$COMMITS" | grep -c "^- fix" || echo 0)
          DOCS_COUNT=$(echo "$COMMITS" | grep -c "^- docs" || echo 0)
          CHORE_COUNT=$(echo "$COMMITS" | grep -c "^- chore" || echo 0)
          REFACTOR_COUNT=$(echo "$COMMITS" | grep -c "^- refactor" || echo 0)
          TEST_COUNT=$(echo "$COMMITS" | grep -c "^- test" || echo 0)
          BREAKING_COUNT=$(echo "$COMMITS" | grep -c "!" || echo 0)

          # Fichiers modifi√©s
          if [ -z "$LAST_TAG" ]; then
            FILES_CHANGED=$(git diff --name-only origin/main...origin/develop | wc -l | tr -d ' ')
            ADDITIONS=$(git diff --shortstat origin/main...origin/develop | grep -oE '[0-9]+ insertion' | grep -oE '[0-9]+' || echo 0)
            DELETIONS=$(git diff --shortstat origin/main...origin/develop | grep -oE '[0-9]+ deletion' | grep -oE '[0-9]+' || echo 0)
          else
            FILES_CHANGED=$(git diff --name-only ${LAST_TAG}..origin/develop | wc -l | tr -d ' ')
            ADDITIONS=$(git diff --shortstat ${LAST_TAG}..origin/develop | grep -oE '[0-9]+ insertion' | grep -oE '[0-9]+' || echo 0)
            DELETIONS=$(git diff --shortstat ${LAST_TAG}..origin/develop | grep -oE '[0-9]+ deletion' | grep -oE '[0-9]+' || echo 0)
          fi

          # D√©terminer le type de release sugg√©r√©
          SUGGESTED_RELEASE="patch"
          if [ $BREAKING_COUNT -gt 0 ]; then
            SUGGESTED_RELEASE="major"
          elif [ $FEAT_COUNT -gt 0 ]; then
            SUGGESTED_RELEASE="minor"
          fi

          echo "COMMITS<<EOF" >> $GITHUB_OUTPUT
          echo "$COMMITS" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
          echo "COMMIT_COUNT=$COMMIT_COUNT" >> $GITHUB_OUTPUT
          echo "LAST_TAG=$LAST_TAG" >> $GITHUB_OUTPUT
          echo "FEAT_COUNT=$FEAT_COUNT" >> $GITHUB_OUTPUT
          echo "FIX_COUNT=$FIX_COUNT" >> $GITHUB_OUTPUT
          echo "DOCS_COUNT=$DOCS_COUNT" >> $GITHUB_OUTPUT
          echo "CHORE_COUNT=$CHORE_COUNT" >> $GITHUB_OUTPUT
          echo "REFACTOR_COUNT=$REFACTOR_COUNT" >> $GITHUB_OUTPUT
          echo "TEST_COUNT=$TEST_COUNT" >> $GITHUB_OUTPUT
          echo "BREAKING_COUNT=$BREAKING_COUNT" >> $GITHUB_OUTPUT
          echo "FILES_CHANGED=$FILES_CHANGED" >> $GITHUB_OUTPUT
          echo "ADDITIONS=$ADDITIONS" >> $GITHUB_OUTPUT
          echo "DELETIONS=$DELETIONS" >> $GITHUB_OUTPUT
          echo "SUGGESTED_RELEASE=$SUGGESTED_RELEASE" >> $GITHUB_OUTPUT

      - name: Create Pull Request
        if: steps.check_pr.outputs.PR_EXISTS == 'false'
        id: create_pr
        run: |
          # Build PR body
          LAST_TAG="${{ steps.get_commits.outputs.LAST_TAG }}"
          COMMITS="${{ steps.get_commits.outputs.COMMITS }}"
          COMMIT_COUNT="${{ steps.get_commits.outputs.COMMIT_COUNT }}"

          if [ -n "$LAST_TAG" ]; then
            TITLE="Release: Promote develop to main (since $LAST_TAG)"
          else
            TITLE="Release: Promote develop to main (initial release)"
          fi

          # R√©cup√©rer les statistiques
          FEAT_COUNT="${{ steps.get_commits.outputs.FEAT_COUNT }}"
          FIX_COUNT="${{ steps.get_commits.outputs.FIX_COUNT }}"
          DOCS_COUNT="${{ steps.get_commits.outputs.DOCS_COUNT }}"
          CHORE_COUNT="${{ steps.get_commits.outputs.CHORE_COUNT }}"
          REFACTOR_COUNT="${{ steps.get_commits.outputs.REFACTOR_COUNT }}"
          TEST_COUNT="${{ steps.get_commits.outputs.TEST_COUNT }}"
          BREAKING_COUNT="${{ steps.get_commits.outputs.BREAKING_COUNT }}"
          FILES_CHANGED="${{ steps.get_commits.outputs.FILES_CHANGED }}"
          ADDITIONS="${{ steps.get_commits.outputs.ADDITIONS }}"
          DELETIONS="${{ steps.get_commits.outputs.DELETIONS }}"
          SUGGESTED_RELEASE="${{ steps.get_commits.outputs.SUGGESTED_RELEASE }}"

          # Badge de breaking change
          BREAKING_BADGE=""
          if [ $BREAKING_COUNT -gt 0 ]; then
            BREAKING_BADGE="
          > ‚ö†Ô∏è **WARNING**: This PR contains $BREAKING_COUNT breaking change(s)!
          "
          fi

          BODY=$(cat <<EOF
          ## üöÄ Promote develop to main

          This PR promotes the current \`develop\` branch to \`main\` for production deployment.

          $BREAKING_BADGE

          ### üìä Statistics

          | Metric | Count |
          |--------|-------|
          | Total Commits | $COMMIT_COUNT |
          | Files Changed | $FILES_CHANGED |
          | Lines Added | +$ADDITIONS |
          | Lines Deleted | -$DELETIONS |

          ### üè∑Ô∏è Commit Types

          | Type | Count |
          |------|-------|
          | ‚ú® Features | $FEAT_COUNT |
          | üêõ Fixes | $FIX_COUNT |
          | üìö Docs | $DOCS_COUNT |
          | üîß Chore | $CHORE_COUNT |
          | ‚ôªÔ∏è Refactor | $REFACTOR_COUNT |
          | ‚úÖ Tests | $TEST_COUNT |
          | üí• Breaking | $BREAKING_COUNT |

          ### üéØ Suggested Release

          Based on commit analysis: **$SUGGESTED_RELEASE**

          <details>
          <summary>üìù View all commits ($COMMIT_COUNT)</summary>

          $COMMITS

          </details>

          ### ‚úÖ Pre-merge Checklist

          - [ ] All CI checks passing
          - [ ] Staging deployment tested
          - [ ] Breaking changes documented (if any)
          - [ ] Version bumped appropriately

          ### üéØ Post-merge Actions

          After merging this PR:
          1. Production will be deployed to Netlify automatically
          2. ${VERSION_TYPE_MSG}

          ---

          **Staging URL**: https://staging--pulse-js.netlify.app
          **Production URL**: https://pulse-js.fr

          <sub>ü§ñ Auto-generated by promote-to-main workflow</sub>
          EOF
          )

          VERSION_TYPE_MSG="Manual release creation required"
          if [ "${{ inputs.version_type }}" != "none" ]; then
            VERSION_TYPE_MSG="Release workflow will be triggered automatically (${{ inputs.version_type }})"
          fi

          BODY=$(echo "$BODY" | sed "s/\${VERSION_TYPE_MSG}/$VERSION_TYPE_MSG/g")

          # Create PR
          PR_URL=$(gh pr create \
            --base main \
            --head develop \
            --title "$TITLE" \
            --body "$BODY" \
            --label "release")

          echo "PR_URL=$PR_URL" >> $GITHUB_OUTPUT
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Add comment to existing PR
        if: steps.check_pr.outputs.PR_EXISTS == 'true'
        run: |
          PR_NUMBER="${{ steps.check_pr.outputs.PR_NUMBER }}"
          gh pr comment $PR_NUMBER --body "üîÑ Workflow re-run requested. Please review changes."
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Create summary
        run: |
          if [ "${{ steps.check_pr.outputs.PR_EXISTS }}" == "true" ]; then
            echo "## ‚ÑπÔ∏è PR Already Exists" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "A PR from \`develop\` to \`main\` already exists:" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "[View PR #${{ steps.check_pr.outputs.PR_NUMBER }}](https://github.com/${{ github.repository }}/pull/${{ steps.check_pr.outputs.PR_NUMBER }})" >> $GITHUB_STEP_SUMMARY
          else
            echo "## ‚úÖ PR Created Successfully!" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**PR URL**: ${{ steps.create_pr.outputs.PR_URL }}" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Commits**: ${{ steps.get_commits.outputs.COMMIT_COUNT }}" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            if [ "${{ inputs.version_type }}" != "none" ]; then
              echo "**Release Type**: ${{ inputs.version_type }}" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "‚ö†Ô∏è After merge, a ${{ inputs.version_type }} release will be created automatically" >> $GITHUB_STEP_SUMMARY
            fi
          fi
