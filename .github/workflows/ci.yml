name: CI

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]
  workflow_dispatch:
    inputs:
      release_type:
        description: 'Release type (leave "none" to only run CI)'
        required: false
        type: choice
        options:
          - none
          - patch
          - minor
          - major
        default: 'none'

permissions:
  contents: read

# Cancel in-progress runs for same PR/branch
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # Detect what changed to skip unnecessary jobs
  changes:
    name: Detect Changes
    runs-on: ubuntu-latest
    timeout-minutes: 2
    outputs:
      src: ${{ steps.filter.outputs.src }}
      tests: ${{ steps.filter.outputs.tests }}
      deps: ${{ steps.filter.outputs.deps }}
      docs: ${{ steps.filter.outputs.docs }}
      ci: ${{ steps.filter.outputs.ci }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Detect changed paths
        uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            src:
              - 'runtime/**'
              - 'compiler/**'
              - 'cli/**'
              - 'loader/**'
              - 'mobile/**'
            tests:
              - 'test/**'
              - 'scripts/run-all-tests.js'
            deps:
              - 'package.json'
              - 'package-lock.json'
            docs:
              - 'docs/**'
              - 'examples/**'
              - '*.md'
            ci:
              - '.github/workflows/**'

  # Security audit - runs only when deps change
  security:
    name: Security Audit
    runs-on: ubuntu-latest
    timeout-minutes: 5
    needs: [changes]
    if: needs.changes.outputs.deps == 'true' || github.event_name == 'workflow_dispatch'
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm'

      - name: Run npm audit
        run: npm audit --audit-level=moderate
        continue-on-error: true

      - name: Check for security vulnerabilities
        run: |
          AUDIT_RESULT=$(npm audit --audit-level=high --json 2>/dev/null || true)
          VULNERABILITIES=$(echo "$AUDIT_RESULT" | jq -r '(.metadata.vulnerabilities.high // 0) + (.metadata.vulnerabilities.critical // 0) + (.metadata.vulnerabilities.moderate // 0)' 2>/dev/null || echo "0")

          if [ "$VULNERABILITIES" -gt 0 ]; then
            echo "::warning::Found $VULNERABILITIES security vulnerabilities"
            npm audit || true
          else
            echo "No high/critical vulnerabilities found"
          fi

  lint:
    name: Syntax Check
    runs-on: ubuntu-latest
    timeout-minutes: 5
    needs: [changes]
    if: needs.changes.outputs.src == 'true' || needs.changes.outputs.ci == 'true' || github.event_name == 'workflow_dispatch'

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Check JavaScript syntax
        run: |
          find . -name "*.js" -not -path "./node_modules/*" -not -path "./dist/*" -print0 \
            | xargs -0 -P4 -n20 node --check

  test:
    name: Test (Node ${{ matrix.node-version }})
    runs-on: ubuntu-latest
    timeout-minutes: 10
    needs: [changes]
    if: >-
      needs.changes.outputs.src == 'true' ||
      needs.changes.outputs.tests == 'true' ||
      needs.changes.outputs.deps == 'true' ||
      needs.changes.outputs.ci == 'true' ||
      github.event_name == 'workflow_dispatch'

    strategy:
      fail-fast: false
      matrix:
        node-version: [20, 22, 24]

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}
          cache: 'npm'

      - name: Cache test results
        uses: actions/cache@v4
        id: test-cache
        if: github.event_name != 'workflow_dispatch'
        with:
          path: .test-results
          key: test-node${{ matrix.node-version }}-${{ hashFiles('runtime/**/*.js', 'compiler/**/*.js', 'cli/**/*.js', 'loader/**/*.js', 'test/**/*.js', 'scripts/**/*.js', 'mobile/**/*.js') }}-${{ hashFiles('package-lock.json') }}

      - name: Install dependencies
        run: npm ci

      - name: Run all tests
        if: steps.test-cache.outputs.cache-hit != 'true'
        run: |
          npm test
          mkdir -p .test-results
          echo "passed" > .test-results/last-pass

      - name: Skip tests (cache hit)
        if: steps.test-cache.outputs.cache-hit == 'true'
        run: echo "Tests already passed for this source+deps hash on Node ${{ matrix.node-version }}, skipping."

  coverage:
    name: Coverage
    runs-on: ubuntu-latest
    timeout-minutes: 10
    needs: [changes]
    if: >-
      needs.changes.outputs.src == 'true' ||
      needs.changes.outputs.tests == 'true' ||
      needs.changes.outputs.deps == 'true' ||
      github.event_name == 'workflow_dispatch'

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm'

      - name: Cache coverage results
        uses: actions/cache@v4
        id: cov-cache
        if: github.event_name != 'workflow_dispatch'
        with:
          path: coverage
          key: coverage-${{ hashFiles('runtime/**/*.js', 'compiler/**/*.js', 'cli/**/*.js', 'loader/**/*.js', 'test/**/*.js', 'scripts/**/*.js', 'mobile/**/*.js') }}-${{ hashFiles('package-lock.json') }}

      - name: Install dependencies
        run: npm ci

      - name: Run tests with coverage
        if: steps.cov-cache.outputs.cache-hit != 'true'
        run: npx c8 --reporter=lcov --reporter=text --reporter=json-summary npm test

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v4
        with:
          files: ./coverage/lcov.info
          fail_ci_if_error: false
          token: ${{ secrets.CODECOV_TOKEN }}

      - name: Check coverage threshold
        run: |
          if [ -f coverage/coverage-summary.json ]; then
            COVERAGE=$(jq '.total.lines.pct' coverage/coverage-summary.json)
            echo "Coverage: $COVERAGE%"
            if (( $(echo "$COVERAGE < 70" | bc -l) )); then
              echo "::warning::Coverage is below 70% ($COVERAGE%)"
            fi
          else
            echo "::warning::Coverage summary not found"
          fi

  build:
    name: Build
    runs-on: ubuntu-latest
    timeout-minutes: 10
    needs: [changes, test, lint]
    if: |
      always() &&
      (needs.test.result == 'success' || needs.test.result == 'skipped') &&
      (needs.lint.result == 'success' || needs.lint.result == 'skipped')

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm'

      - name: Cache build output
        uses: actions/cache@v4
        id: build-cache
        with:
          path: dist
          key: build-${{ hashFiles('runtime/**/*.js', 'compiler/**/*.js', 'cli/**/*.js', 'loader/**/*.js', 'docs/**', 'scripts/**/*.js', 'mobile/**/*.js') }}-${{ hashFiles('package-lock.json') }}

      - name: Install dependencies
        if: steps.build-cache.outputs.cache-hit != 'true'
        run: npm ci

      - name: Build for Netlify
        if: steps.build-cache.outputs.cache-hit != 'true'
        run: npm run build:netlify

      - name: Verify build output
        run: |
          test -d dist
          test -f dist/index.html
          echo "Build successful!"

      - name: Check bundle size
        run: |
          TOTAL_SIZE=$(du -sb dist | awk '{print $1}')
          TOTAL_SIZE_MB=$(echo "scale=2; $TOTAL_SIZE / 1024 / 1024" | bc)

          echo "Bundle size: ${TOTAL_SIZE_MB}MB"
          echo "BUNDLE_SIZE=${TOTAL_SIZE_MB}" >> $GITHUB_ENV

          if (( $(echo "$TOTAL_SIZE_MB > 10" | bc -l) )); then
            echo "::warning::Bundle size is large (${TOTAL_SIZE_MB}MB). Consider optimization."
          fi

          echo "Largest files:"
          find dist -type f -exec du -h {} + | sort -rh | head -10

      - name: Compress build artifact
        run: |
          cd dist
          tar -czf ../dist.tar.gz .
          cd ..
          echo "Compressed size: $(du -h dist.tar.gz | awk '{print $1}')"

      - name: Upload build artifact (compressed)
        uses: actions/upload-artifact@v4
        with:
          name: dist
          path: dist.tar.gz
          retention-days: ${{ github.ref == 'refs/heads/main' && 30 || 7 }}
          compression-level: 9

  deploy:
    name: Deploy to Netlify (Production)
    runs-on: ubuntu-latest
    timeout-minutes: 10
    needs: [build]
    if: |
      always() &&
      needs.build.result == 'success' &&
      github.ref == 'refs/heads/main' &&
      (github.event_name == 'push' || github.event_name == 'workflow_dispatch')
    permissions:
      contents: read
      deployments: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Download build artifact
        uses: actions/download-artifact@v4
        with:
          name: dist

      - name: Extract build artifact
        run: |
          mkdir -p dist
          tar -xzf dist.tar.gz -C dist
          rm dist.tar.gz

      - name: Deploy to Netlify
        id: netlify
        uses: nwtgck/actions-netlify@v3
        with:
          publish-dir: './dist'
          production-deploy: true
          github-token: ${{ secrets.GITHUB_TOKEN }}
          deploy-message: 'Deploy from GitHub Actions - ${{ github.sha }}'
        env:
          NETLIFY_AUTH_TOKEN: ${{ secrets.NETLIFY_AUTH_TOKEN }}
          NETLIFY_SITE_ID: ${{ secrets.NETLIFY_SITE_ID }}

      - name: Create deployment summary
        if: success()
        run: |
          echo "## Production Deployment Successful" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Production URL**: ${{ steps.netlify.outputs.deploy-url }}" >> $GITHUB_STEP_SUMMARY
          echo "**Live Site**: https://pulse-js.fr" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Deployment Info" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit**: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Branch**: main" >> $GITHUB_STEP_SUMMARY
          echo "- **Time**: $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY

  # Release job - only runs when manually triggered with a release type
  release:
    name: Trigger Release
    runs-on: ubuntu-latest
    timeout-minutes: 5
    needs: [test, lint, build, coverage]
    permissions:
      contents: write
      actions: write
    if: |
      always() &&
      (needs.test.result == 'success' || needs.test.result == 'skipped') &&
      (needs.lint.result == 'success' || needs.lint.result == 'skipped') &&
      needs.build.result == 'success' &&
      (needs.coverage.result == 'success' || needs.coverage.result == 'skipped') &&
      github.ref == 'refs/heads/main' &&
      github.event_name == 'workflow_dispatch' &&
      inputs.release_type != 'none'

    steps:
      - name: Trigger Manual Release workflow
        uses: actions/github-script@v8
        with:
          script: |
            await github.rest.actions.createWorkflowDispatch({
              owner: context.repo.owner,
              repo: context.repo.repo,
              workflow_id: 'manual-release.yml',
              ref: context.ref,
              inputs: {
                release_type: '${{ inputs.release_type }}'
              }
            });

            console.log('Triggered manual-release.yml with release_type: ${{ inputs.release_type }}');

      - name: Release summary
        run: |
          echo "## Release Triggered" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "All CI checks passed. Triggered **${{ inputs.release_type }}** release." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "[View Release Workflow](https://github.com/${{ github.repository }}/actions/workflows/manual-release.yml)" >> $GITHUB_STEP_SUMMARY

  # Discord notification on failure (main branch only)
  notify-discord:
    name: Notify Discord on Failure
    runs-on: ubuntu-latest
    timeout-minutes: 2
    needs: [lint, test, coverage, build, deploy]
    if: >-
      always() &&
      github.ref == 'refs/heads/main' &&
      github.event_name == 'push' &&
      (
        needs.lint.result == 'failure' ||
        needs.test.result == 'failure' ||
        needs.coverage.result == 'failure' ||
        needs.build.result == 'failure' ||
        needs.deploy.result == 'failure'
      )

    steps:
      - name: Build failure report
        id: report
        run: |
          FAILED_JOBS=""
          [ "${{ needs.lint.result }}" = "failure" ] && FAILED_JOBS="${FAILED_JOBS}Lint, "
          [ "${{ needs.test.result }}" = "failure" ] && FAILED_JOBS="${FAILED_JOBS}Test, "
          [ "${{ needs.coverage.result }}" = "failure" ] && FAILED_JOBS="${FAILED_JOBS}Coverage, "
          [ "${{ needs.build.result }}" = "failure" ] && FAILED_JOBS="${FAILED_JOBS}Build, "
          [ "${{ needs.deploy.result }}" = "failure" ] && FAILED_JOBS="${FAILED_JOBS}Deploy, "
          FAILED_JOBS="${FAILED_JOBS%, }"
          echo "FAILED_JOBS=$FAILED_JOBS" >> $GITHUB_OUTPUT

      - name: Send Discord notification
        env:
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
        run: |
          COMMIT_MSG=$(echo "${{ github.event.head_commit.message }}" | head -1 | cut -c1-80)
          RUN_URL="${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          COMMIT_URL="${{ github.server_url }}/${{ github.repository }}/commit/${{ github.sha }}"
          SHORT_SHA=$(echo "${{ github.sha }}" | cut -c1-7)

          TIMESTAMP=$(date -u +%Y-%m-%dT%H:%M:%SZ)

          PAYLOAD=$(cat <<EOF
          {
            "embeds": [{
              "title": "CI Failed on main",
              "color": 15548997,
              "description": "**Failed jobs:** ${{ steps.report.outputs.FAILED_JOBS }}",
              "fields": [
                {
                  "name": "Commit",
                  "value": "[\`${SHORT_SHA}\`](${COMMIT_URL}) ${COMMIT_MSG}",
                  "inline": false
                },
                {
                  "name": "Author",
                  "value": "${{ github.actor }}",
                  "inline": true
                },
                {
                  "name": "Branch",
                  "value": "main",
                  "inline": true
                },
                {
                  "name": "Workflow",
                  "value": "[View run](${RUN_URL})",
                  "inline": true
                }
              ],
              "timestamp": "${TIMESTAMP}",
              "footer": {
                "text": "Pulse CI"
              }
            }]
          }
          EOF
          )

          curl -s -X POST "$DISCORD_WEBHOOK_URL" \
            -H "Content-Type: application/json" \
            -d "$PAYLOAD"
