name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

# Cancel in-progress runs for same PR/branch
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # Security audit - runs first and fast
  security:
    name: Security Audit
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm'

      - name: Run npm audit
        run: npm audit --audit-level=moderate
        continue-on-error: true

      - name: Check for security vulnerabilities
        run: |
          AUDIT_RESULT=$(npm audit --audit-level=high --json)
          VULNERABILITIES=$(echo "$AUDIT_RESULT" | jq -r '.metadata.vulnerabilities.high + .metadata.vulnerabilities.critical + .metadata.vulnerabilities.moderate')

          if [ "$VULNERABILITIES" -gt 0 ]; then
            echo "::warning::Found $VULNERABILITIES security vulnerabilities"
            npm audit
          else
            echo "No high/critical vulnerabilities found"
          fi

  test:
    name: Test (Node ${{ matrix.node-version }})
    runs-on: ubuntu-latest
    needs: security

    strategy:
      fail-fast: false
      matrix:
        node-version: [18, 20, 22]

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}
          cache: 'npm'

      - name: Cache node_modules
        uses: actions/cache@v4
        with:
          path: node_modules
          key: ${{ runner.os }}-node-${{ matrix.node-version }}-${{ hashFiles('package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-node-${{ matrix.node-version }}-
            ${{ runner.os }}-node-

      - name: Install dependencies
        run: npm ci

      - name: Run all tests
        run: npm test

  coverage:
    name: Coverage
    runs-on: ubuntu-latest
    needs: security

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm'

      - name: Cache node_modules
        uses: actions/cache@v4
        with:
          path: node_modules
          key: ${{ runner.os }}-node-20-${{ hashFiles('package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-node-20-
            ${{ runner.os }}-node-

      - name: Install dependencies
        run: npm ci

      - name: Run tests with coverage
        run: npx c8 --reporter=lcov --reporter=text npm test

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v5
        with:
          files: ./coverage/lcov.info
          fail_ci_if_error: false
          token: ${{ secrets.CODECOV_TOKEN }}

      - name: Check coverage threshold
        run: |
          COVERAGE=$(npx c8 report --reporter=json-summary | jq '.total.lines.pct')
          echo "Coverage: $COVERAGE%"
          if (( $(echo "$COVERAGE < 70" | bc -l) )); then
            echo "::warning::Coverage is below 70% ($COVERAGE%)"
          fi

  lint:
    name: Syntax Check
    runs-on: ubuntu-latest
    needs: security

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Check JavaScript syntax
        run: |
          find . -name "*.js" -not -path "./node_modules/*" -not -path "./dist/*" | while read file; do
            node --check "$file" || exit 1
          done

  build:
    name: Build
    runs-on: ubuntu-latest
    needs: [test, lint]

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm'

      - name: Cache node_modules
        uses: actions/cache@v4
        with:
          path: node_modules
          key: ${{ runner.os }}-node-20-${{ hashFiles('package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-node-20-
            ${{ runner.os }}-node-

      - name: Install dependencies
        run: npm ci

      - name: Build for Netlify
        run: npm run build:netlify

      - name: Verify build output
        run: |
          test -d dist
          test -f dist/index.html
          echo "Build successful!"

      - name: Check bundle size
        run: |
          # Calculate total size
          TOTAL_SIZE=$(du -sb dist | awk '{print $1}')
          TOTAL_SIZE_MB=$(echo "scale=2; $TOTAL_SIZE / 1024 / 1024" | bc)

          echo "ðŸ“¦ Bundle size: ${TOTAL_SIZE_MB}MB"
          echo "BUNDLE_SIZE=${TOTAL_SIZE_MB}" >> $GITHUB_ENV

          # Warn if bundle is too large (>10MB)
          if (( $(echo "$TOTAL_SIZE_MB > 10" | bc -l) )); then
            echo "::warning::Bundle size is large (${TOTAL_SIZE_MB}MB). Consider optimization."
          fi

          # Find largest files
          echo "ðŸ“Š Largest files:"
          find dist -type f -exec du -h {} + | sort -rh | head -10

      - name: Compress build artifact
        run: |
          cd dist
          tar -czf ../dist.tar.gz .
          cd ..
          echo "Compressed size: $(du -h dist.tar.gz | awk '{print $1}')"

      - name: Upload build artifact (compressed)
        uses: actions/upload-artifact@v4
        with:
          name: dist
          path: dist.tar.gz
          retention-days: ${{ github.ref == 'refs/heads/main' && 30 || 7 }}
          compression-level: 9

  deploy:
    name: Deploy to Netlify (Production)
    runs-on: ubuntu-latest
    needs: [build]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Download build artifact
        uses: actions/download-artifact@v4
        with:
          name: dist

      - name: Extract build artifact
        run: |
          mkdir -p dist
          tar -xzf dist.tar.gz -C dist
          rm dist.tar.gz

      - name: Deploy to Netlify
        id: netlify
        uses: nwtgck/actions-netlify@v3
        with:
          publish-dir: './dist'
          production-deploy: true
          github-token: ${{ secrets.GITHUB_TOKEN }}
          deploy-message: 'Deploy from GitHub Actions - ${{ github.sha }}'
        env:
          NETLIFY_AUTH_TOKEN: ${{ secrets.NETLIFY_AUTH_TOKEN }}
          NETLIFY_SITE_ID: ${{ secrets.NETLIFY_SITE_ID }}

      - name: Check if release is needed
        id: check_release
        if: success()
        run: |
          # Get the last commit message
          LAST_COMMIT=$(git log -1 --pretty=%B)

          # Check if it's NOT already a release commit
          if echo "$LAST_COMMIT" | grep -qE "^v[0-9]+\.[0-9]+\.[0-9]+"; then
            echo "SKIP_PROMPT=true" >> $GITHUB_OUTPUT
            echo "Last commit is already a release, skipping prompt"
          else
            echo "SKIP_PROMPT=false" >> $GITHUB_OUTPUT
            echo "Deploy successful, could create a release"
          fi

      - name: Create deployment summary with release option
        if: success() && steps.check_release.outputs.SKIP_PROMPT == 'false'
        run: |
          echo "## âœ… Deployment Successful!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ“¦ **Netlify URL**: ${{ steps.netlify.outputs.deploy-url }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸš€ Ready to Create a Release?" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Click one of the links below to create a new release:" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- [ðŸ› **Patch Release** (bug fixes)](https://github.com/${{ github.repository }}/actions/workflows/create-release.yml?version_type=patch)" >> $GITHUB_STEP_SUMMARY
          echo "- [âœ¨ **Minor Release** (new features)](https://github.com/${{ github.repository }}/actions/workflows/create-release.yml?version_type=minor)" >> $GITHUB_STEP_SUMMARY
          echo "- [ðŸ’¥ **Major Release** (breaking changes)](https://github.com/${{ github.repository }}/actions/workflows/create-release.yml?version_type=major)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "> ðŸ’¡ Or go to [Actions > Create Release](https://github.com/${{ github.repository }}/actions/workflows/create-release.yml) and click **Run workflow**" >> $GITHUB_STEP_SUMMARY
