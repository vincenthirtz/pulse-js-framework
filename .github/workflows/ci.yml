name: CI

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]
  workflow_dispatch:

permissions:
  contents: read

# Cancel in-progress runs for same PR/branch
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # Security audit - runs in parallel (advisory only)
  security:
    name: Security Audit
    runs-on: ubuntu-latest
    timeout-minutes: 5
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm'

      - name: Run npm audit
        run: npm audit --audit-level=moderate
        continue-on-error: true

      - name: Check for security vulnerabilities
        run: |
          AUDIT_RESULT=$(npm audit --audit-level=high --json 2>/dev/null || true)
          VULNERABILITIES=$(echo "$AUDIT_RESULT" | jq -r '(.metadata.vulnerabilities.high // 0) + (.metadata.vulnerabilities.critical // 0) + (.metadata.vulnerabilities.moderate // 0)' 2>/dev/null || echo "0")

          if [ "$VULNERABILITIES" -gt 0 ]; then
            echo "::warning::Found $VULNERABILITIES security vulnerabilities"
            npm audit || true
          else
            echo "No high/critical vulnerabilities found"
          fi

  lint:
    name: Syntax Check
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Check JavaScript syntax
        run: |
          find . -name "*.js" -not -path "./node_modules/*" -not -path "./dist/*" -print0 \
            | xargs -0 -P4 -n20 node --check

  test:
    name: Test (Node ${{ matrix.node-version }})
    runs-on: ubuntu-latest
    timeout-minutes: 10

    strategy:
      fail-fast: false
      matrix:
        node-version: [18, 20, 22]

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run all tests
        run: npm test

  coverage:
    name: Coverage
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run tests with coverage
        run: npx c8 --reporter=lcov --reporter=text --reporter=json-summary npm test

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v4
        with:
          files: ./coverage/lcov.info
          fail_ci_if_error: false
          token: ${{ secrets.CODECOV_TOKEN }}

      - name: Check coverage threshold
        run: |
          if [ -f coverage/coverage-summary.json ]; then
            COVERAGE=$(jq '.total.lines.pct' coverage/coverage-summary.json)
            echo "Coverage: $COVERAGE%"
            if (( $(echo "$COVERAGE < 70" | bc -l) )); then
              echo "::warning::Coverage is below 70% ($COVERAGE%)"
            fi
          else
            echo "::warning::Coverage summary not found"
          fi

  build:
    name: Build
    runs-on: ubuntu-latest
    timeout-minutes: 10
    needs: [test, lint]

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build for Netlify
        run: npm run build:netlify

      - name: Verify build output
        run: |
          test -d dist
          test -f dist/index.html
          echo "Build successful!"

      - name: Check bundle size
        run: |
          TOTAL_SIZE=$(du -sb dist | awk '{print $1}')
          TOTAL_SIZE_MB=$(echo "scale=2; $TOTAL_SIZE / 1024 / 1024" | bc)

          echo "Bundle size: ${TOTAL_SIZE_MB}MB"
          echo "BUNDLE_SIZE=${TOTAL_SIZE_MB}" >> $GITHUB_ENV

          if (( $(echo "$TOTAL_SIZE_MB > 10" | bc -l) )); then
            echo "::warning::Bundle size is large (${TOTAL_SIZE_MB}MB). Consider optimization."
          fi

          echo "Largest files:"
          find dist -type f -exec du -h {} + | sort -rh | head -10

      - name: Compress build artifact
        run: |
          cd dist
          tar -czf ../dist.tar.gz .
          cd ..
          echo "Compressed size: $(du -h dist.tar.gz | awk '{print $1}')"

      - name: Upload build artifact (compressed)
        uses: actions/upload-artifact@v4
        with:
          name: dist
          path: dist.tar.gz
          retention-days: ${{ github.ref == 'refs/heads/main' && 30 || 7 }}
          compression-level: 9

  deploy:
    name: Deploy to Netlify (Production)
    runs-on: ubuntu-latest
    timeout-minutes: 10
    needs: [build]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    permissions:
      contents: read
      deployments: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Download build artifact
        uses: actions/download-artifact@v4
        with:
          name: dist

      - name: Extract build artifact
        run: |
          mkdir -p dist
          tar -xzf dist.tar.gz -C dist
          rm dist.tar.gz

      - name: Deploy to Netlify
        id: netlify
        uses: nwtgck/actions-netlify@v3
        with:
          publish-dir: './dist'
          production-deploy: true
          github-token: ${{ secrets.GITHUB_TOKEN }}
          deploy-message: 'Deploy from GitHub Actions - ${{ github.sha }}'
        env:
          NETLIFY_AUTH_TOKEN: ${{ secrets.NETLIFY_AUTH_TOKEN }}
          NETLIFY_SITE_ID: ${{ secrets.NETLIFY_SITE_ID }}

      - name: Create deployment summary
        if: success()
        run: |
          echo "## Production Deployment Successful" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Production URL**: ${{ steps.netlify.outputs.deploy-url }}" >> $GITHUB_STEP_SUMMARY
          echo "**Live Site**: https://pulse-js.fr" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Deployment Info" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit**: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Branch**: main" >> $GITHUB_STEP_SUMMARY
          echo "- **Time**: $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
